- hosts: servers
  become: true
  inventory:
    [servers]
    vds3 ansible_host=vds3.iri1968.dpdns.org
    gw ansible_host=gw.iri1968.dpdns.org
  tasks:
    - name: 'Update apt package cache'
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: 'Upgrade all packages to the latest version'
      ansible.builtin.apt:
        upgrade: 'dist'
        autoremove: true

    - name: 'Check if a reboot is required'
      ansible.builtin.stat:
        path: '/var/run/reboot-required'
      register: 'reboot_required_file'

    - name: 'Reboot the server if required'
      ansible.builtin.reboot:
        msg: 'Reboot initiated by Ansible due to kernel updates'
      when: reboot_required_file.stat.exists
