# Сводка по сессии Ansible и настройке Caddy/Grafana

Этот документ содержит обзор проблем, с которыми мы столкнулись во время настройки автоматизации Ansible, и шаги, которые были предприняты для их решения.

---

## 1. Изначальная задача

Настроить Grafana по HTTPS через домен `https://notebook.iri1968.dpdns.org`. Изначально предполагалось использовать `cert-manager` внутри кластера k3s, но из-за проблем с сетевой доступностью и конфликтов с Traefik, подход был изменен на использование Caddy на хост-машине.

---

## 2. Ключевые проблемы и их решения

### 2.1. Проблемы с сетевой доступностью извне (Let's Encrypt и Caddy)

*   **Проблема:** Серверы Let's Encrypt не могли подключиться к `notebook.iri1968.dpdns.org` по портам 80/443 (ошибки "Timeout during connect", "404 Not Found" от внешнего сервиса). Это мешало автоматическому получению сертификатов.
*   **Решение:** Пользователь самостоятельно устранил проблему с пробросом портов на роутере. Тесты показали, что после этого внешний доступ по 443 порту стал работать.

### 2.2. Конфликт портов на хост-машине (Caddy vs Nginx, Caddy vs Traefik)

*   **Проблема 1: Nginx занимал порт 80.** Caddy не мог запуститься.
    *   **Решение:** Остановили и отключили `nginx` (`sudo systemctl stop nginx && sudo systemctl disable nginx`).
*   **Проблема 2: Traefik занимал порт 443.** Даже после запуска Caddy, на 443 порту продолжал отвечать Traefik (Ingress-контроллер k3s), отдавая свой дефолтный сертификат.
    *   **Причина:** Traefik, установленный через Helm, прослушивал порты 80/443 хоста.
    *   **Решение:** Удаление Helm-релиза Traefik. Для этого потребовалось явно указывать `kubeconfig` путь:
        ```bash
        sudo helm uninstall traefik -n kube-system --kubeconfig /etc/rancher/k3s/k3s.yaml
        ```

### 2.3. Проблемы с модулями Ansible (community.kubernetes)

*   **Проблема 1: `couldn't resolve module/action 'community.kubernetes.k8s_patch'`**
    *   **Причина 1:** Отсутствовала Python-библиотека `kubernetes`.
    *   **Решение 1:** Установили `python3-kubernetes` через `apt`.
    *   **Причина 2:** Сетевые проблемы мешали `ansible-galaxy` скачать коллекцию (`The read operation timed out`, `Соединение разорвано другой стороной`).
    *   **Решение 2:** Коллекция была установлена после устранения прокси-конфликтов.
    *   **Причина 3 (основная):** Даже после установки коллекции и зависимости, `ansible-playbook` не мог найти модули. Это указывало на глубинную проблему с окружением Ansible или его путями поиска модулей/коллекций.
    *   **Решение 3 (обходной путь):** Заменили прямые вызовы `community.kubernetes` модулей на `ansible.builtin.shell` с выполнением команд `kubectl`.

*   **Проблема 2: `ansible.cfg` игнорируется.**
    *   **Причина:** Ansible не загружал `ansible.cfg` из текущей рабочей директории.
    *   **Решение:** Запускаем плейбук с явным указанием пути к `ansible.cfg` через переменную `ANSIBLE_CONFIG`.

### 2.4. Настройка Caddy для HTTPS через `acme.sh`

*   **Проблема:** Изначально Caddy пытался получить сертификат сам (что приводило к ошибкам из-за сетевых проблем), а затем был настроен на самоподписанный. Пользователь запросил использование `acme.sh`.
*   **Решение:**
    *   В плейбук добавлена установка `acme.sh` (через `git clone`).
    *   Добавлена задача для выпуска/обновления сертификата через `acme.sh` с использованием Cloudflare DNS (`--dns dns_cf`).
    *   Найден и использован `CF_Token` с сервера `vds3`.
    *   Сертификаты копируются из директории `acme.sh` в `/etc/caddy/certs/`.
    *   `Caddyfile` настроен на использование этих файлов.
    *   Добавлена обработка `rc=2` для `acme.sh` (успешный пропуск обновления).

---

## 3. Текущее состояние и использование плейбука

Плейбук `/mnt/usb_hdd1/Projects/Ansible/setup_caddy_proxy.yml` теперь полностью автоматизирует:

1.  Остановку и отключение `nginx`.
2.  Установку Caddy и необходимых Python-зависимостей.
3.  Установку `acme.sh` в домашнюю директорию `igor`.
4.  Выпуск/обновление сертификата Let's Encrypt для `notebook.iri1968.dpdns.org` через `acme.sh` (используя Cloudflare DNS API).
5.  Копирование полученных сертификатов в `/etc/caddy/certs/` с правильными правами.
6.  Изменение типа сервиса Grafana на `NodePort` и получение назначенного порта (через `kubectl`).
7.  Конфигурацию `Caddyfile` для проксирования на Grafana с использованием нового сертификата.
8.  Перезапуск Caddy.

**Для запуска плейбука используйте следующую команду:**

```bash
ANSIBLE_CONFIG=/mnt/usb_hdd1/Projects/Ansible/ansible.cfg ansible-playbook /mnt/usb_hdd1/Projects/Ansible/setup_caddy_proxy.yml
```

---

## 4. Рекомендации

*   **Для Ansible:** Если проблемы с разрешением модулей `community.kubernetes` будут продолжаться, рассмотрите полную переустановку Ansible или его запуск в более изолированном/контролируемом окружении (например, в Docker-контейнере), где можно четко контролировать пути коллекций и Python-зависимости.
*   **Для `acme.sh`:** Убедитесь, что `acme.sh` имеет возможность записи в свою директорию `/home/igor/.acme.sh` и что переменная окружения `CF_Token` (или любая другая, используемая вашим DNS-провайдером) корректно передается.
*   **Добавление новых сервисов:** Для добавления других сервисов в `Caddyfile` вам потребуется:
    1.  Изменить их тип на `NodePort` в Kubernetes.
    2.  Получить назначенный `NodePort`.
    3.  Добавить новый блок в `/mnt/usb_hdd1/Projects/Ansible/templates/Caddyfile.j2` с соответствующим доменом и `reverse_proxy localhost:<NODE_PORT>`.
    4.  Запустить плейбук повторно.
